name: Build and Deploy Site to GitHub Pages

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      # Installs Python specified in pyproject.toml
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: "pyproject.toml"

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          # Install a specific version of uv.
          version: "0.8.22"
          # Cache project deps
          # https://docs.astral.sh/uv/guides/integration/github/#caching
          enable-cache: true

      - name: Build static assets
        run: |
          npm clean-install
          npm run dist

      - name: Install project deps
        run: uv sync --locked --all-extras --dev

      - name: Build site with Pelican
        id: run-pelican
        run: |
          uv run inv preview

      # This step installs the ssh client into the workflow run.
      # There's many options available for this on the action marketplace.
      - name: Install SSH Client
        uses: webfactory/ssh-agent@v0.4.1
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Build and Deploy Repo
        uses: JamesIves/github-pages-deploy-action@releases/v3
        with:
          BASE_BRANCH: main
          BRANCH: gh-pages
          FOLDER: output
          CLEAN: true
          SSH: true # SSH must be set to true so the deploy action knows which protocol to deploy with.
